Решение автоматизации “Simple-Deploy” для доставки и сборки кода с GitHub на удаленный сервер AWS EC2.

Данное решение поможет разработчику ускорить процесс создания инстансов EC2, а также групп безопасности на платформе AWS.

Данное решение помогает упростить процесс доставки кода на Web-сервер пользователя сразу после обновления (Pull) кода на GitHub. При использовании данного решения можно произвести промежуточные тесты кода на предмет наличия определенных слов или фраз, а также проверить html код на наличие ошибок в синтаксисе. 


Данное решение включает в себя использование следующих инструментов и сервисов: 

Terraform
AWS EC2, Route53
Jenkins
Github


Также данное решение требует наличие следующих элементов:

Зарегистрированный аккаунт AWS 
Зарегистрированный аккаунт GitHub
Установленный Terraform 


Этап 1. Подготовка к работе с Terraform.

Для того чтобы терраформ файл находящийся в репозитории данного проекта можно было использовать для создания собственных инстансов, потребуется получить учетные данные AWS. Сделать это можно перейдя в раздел IAM по следующей ссылке: https://console.aws.amazon.com/iamv2 . В данном разделе в меню слева выбрать раздел “Users” и далее нажать кнопку “Add User”.
Далее вы увидите страницу “Set user details” где потребуется ввести имя пользователя и выбрать опцию “AWS credential type” - “Access key - Programmatic access” и нажать клавишу Next.
На следующем этапе потребуется добавить пользователю права для работы c AWS. В меню “Set permissions” выбрать “Attach existing policies directly” в выпадающем списке выбрать “Administrator Access” и перейти далее. 
Следующий пункт “Add tags” опционален. При желании добавьте теги для пользователя. Перейдите далее.
Раздел “Review” покажет вам информацию о создаваемом вами пользователе. Нажмите кнопку Create User если вся информация верна.
Внимание на данном этапе вы уже создали пользователя и на этой странице находиться важная информация. Access key ID вы видите в открытом виде, скопируйте его, Secret access key  вы видите в скрытом виде, нажмите кнопку show для отображения. ВНИМАНИЕ Secret access key  выдается только один раз на этой странице. Получить его повторно для этого пользователя не получится. Скопируйте оба ключа в надежное место.
Для обеспечения доступа по ssh на будущие сервера требуется создать ssh ключ. Перейдите по ссылке https://eu-central-1.console.aws.amazon.com/ec2/v2/home?region=eu-central-1#KeyPairs  и нажмите кнопку “Create key pair” . Введите имя для вашего ключа и выберите удобный для вас “Private key file format” и нажмите “Create key pair” . Выполните загрузку ключа на свой компьютер.


Этап 2. Работа с Terraform

Откройте Terraform файл находящийся в данном проекте для изменений в удобном для вас текстовом редакторе.
В первом блоке кода потребуется ввести свои Access key и Secret key полученные ранее. Также потребуется указать регион в котором вы хотите создать инстансы AWS. В нашем случае это регион "eu-central-1".
Далее в файле необходимо заменить key_name на имя ssh pair которые вы создали ранее в AWS.
Сохраните Terraform файл и переместите с уже ранее установленным Terraform в одну директорию. В командной строке введите команду terraform init произойдет загрузка необходимых библиотек для работы с AWS.
Далее выполните команду terraform plan  в выводе вы увидите что будет создано в облаке Amazon  с помощью Terraform. В нашем случае это 2 инстанса EC2 и Security Group для полного доступа во внешний интернет.
Далее выполните команду terraform apply для применения и дальнейшего создания инфраструктуры. Потребуется дополнительно ввести “yes” если вы согласны на данную операцию.
Terraform потребуется некоторое время для создания инстансов. При завершении создания инстансов вы увидите сообщение о том что инстансы успешно созданы. Проверить их наличие можно по следующей ссылке https://eu-central-1.console.aws.amazon.com/ec2 .


Этап 3. Подготовка Веб сервера.

Выполните вход по ssh на инстанс под названием “My_Web” созданный в AWS с помощью Terraform.  
Выполните следующие команды: sudo apt update
sudo apt install apache2
Проверить статус работы можно с помощью команды sudo systemctl status apache2
В случае если сервис не запустился автоматически потребуется ручной запуск с помощь команды sudo systemctl start apache2 в случае если требуется перезапуск сервиса используйте команду sudo systemctl restart apache2


Этап 4. Подготовка сервера Jenkins.
    
Выполните вход по ssh на инстанс под названием “My_Jenkins” созданный в AWS с помощью Terraform.  
Выполните следующие команды: sudo apt update
Требуется установка Java для работы Jenkins sudo apt install openjdk-11-jdk
sudo wget -q -O - https://pkg.jenkins.io/debian/jenkins.io.key | sudo apt-key add -
sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
sudo apt update 
sudo apt install jenkins
Можно проверить статус Jenkins c помощью команды sudo systemctl status jenkins
Зайдите в браузере по адресу вашего сервера на порт 8080 к примеру:  http://3.69.29.122:8080
Выполните действия по подсказкам на странице. Выберите рекомендуемый набор плагинов, это сэкономит время в будущем.


Этап 5. Настройка Jenkins.

Переходим в настройки плагинов Jenkins http://your_jenkins_ip:8080/pluginManager/available и устанавливаем плагин Publish Over SSH  с его помощью можно зайти на наш веб сервер и разместить там новую версию сайта.
Переходим в настройки Jenkins http://your_jenkins_ip:8080/configure находим там пунткт Publish over SSH  и вносим туда свой ключ полученный ранее на AWS.
Добавляем данные сервера на котором у нас будет сайт, Name - произвольное имя, hostname - ip адрес ранее созданного инстанса “My_Web”, Username - ubuntu,  Remote Directory -  /var/www/html . Обязательно нажмите Применить и Сохранить по окончанию настройки.
Создаем новый Job http://your_jenkins_ip:8080/view/all/newJob Выбираем “Создать задачу со свободной конфигурацией”. 
В пункте “Общие” Выбрать “GitHub project” и указываем ssh ссылку на Ваш репозиторий. К примеру: git@github.com:Your_username/Your_project_name.git/ 
В пункте “Управление исходным кодом” выбираем GIT и так же указываем ssh ссылку на Ваш репозиторий
Далее необходимо дать возможность Jenkins использовать Ваш репозиторий, для этого нужно сделать новые ssh ключи. Используйте команду ssh-keygen
Нажмите кнопку “Add” и выберите “Jenkins”.
“Kind”  выбрать “SSH Username with private key”
Назначьте произвольные “ID” и “Description”.
Поле Username должно соответствовать вашему логину на GitHub.
В “Private Key” нажмите “Enter directly” появится поле для ввода ключа. Введите содержимое файла без расширения созданного ранее при помощи ssh-keygen
В пункте “Триггеры сборки” выбрать “GitHub hook trigger for GITScm polling”
Добавить дополнительные тесты или операции перед доставкой кода можно с помощью кнопки “Добавить шаг сборки”
Для доставки файлов по ssh на наш ранее созданный веб сервер “My_Web” можно по нажатию “Добавить шаг сборки” выбрав “Send files or execute commands over SSH” Выберите уже настроенный ранее сервер для отправки данных. “Remote directory”  можно указать корневой каталог, т.к. мы ранее указали /var/www/html . “Exec command” можно отправить на сервер любую команду после перемещения файлов проекта. Рекомендую перезапустить Apache во избежание проблем sudo service apache2 restart . 




Этап 6. Настройка GitHub

Для автоматизации доставки кода сразу после Pull на GitHub нам потребуется добавить ssh ключ  https://github.com/settings/keys . Выберите “New SSH Key” далее укажите “Title” произвольное имя. Введите содержимое файла  *.Pub созданного ранее при помощи ssh-keygen
Зайдите в настройки репозитория который необходимо будет доставить на сервер и настройте Webhook. К примеру https://github.com/Your_username/Your_project_name/settings/hooks , выберите “Add webhook”, “Payload URL”  http://your_jenkins_ip:8080/github-webhook/ , “Content type” - “application/json” .


Этап 7. Настройка доменного имени в AWS Route 53 (Опционально)

При необходимости использовать доменное имя вместо ip адреса для доступа к сайту, потребуется приобрести его в сервисе Route53 и присвоить Вашему Web-серверу.

Перейдите по адресу https://console.aws.amazon.com/route53/v2 
Выберите “Register domain” Введите желаемое имя для Вашего сайта.
При наличии или отсутствии данного имени вы будете перенаправлены на страницу “Choose a domain name” где сможете выбрать доступное имя и домен второго уровня.
Выберите желаемое доменное имя, добавьте в корзину и выполните оплату.
Купленное доменное имя можно првоерить перейдя по следующей ссылке https://console.aws.amazon.com/route53/home#DomainListing:
Далее перейдите в “Hosted Zone” и выберите свое доменное имя. https://console.aws.amazon.com/route53/v2/hostedzones
Нажмите “Create record”. Выберите “Simple routing” и нажмите “Next”
Нажмите “Define simple record”. “Value/Route traffic to” выберите “IP address or another value, depending on the record type” ниже введите IP адрес вашего веб-сервера. 


Этап 8. Настройка мониторинга Zabbix (Опционально)

При необходимости получать отчеты о проблемах в работе серверов и/или их недоступности можно настроить систему мониторинга.

Для настройки сервера заббикс можно в ручном режиме развернуть еще один инстанс EC2.
Подключится к нему используя “ssh key pair” созданные ранее в Вашем аккаунте AWS.
Выполнить настройку сервера согласно инструкции от поставщика ПО. https://www.zabbix.com/ru/download?zabbix=5.0&os_distribution=ubuntu&os_version=20.04_focal&db=postgresql&ws=nginx
Выполнить установку zabbix-agent на сервера для мониторинга. sudo apt install zabbix-agent
Добавить хосты для мониторинга на Zabbix сервере.
При необходимости настроить передачу Alert-ов в мессенджер Telegram согласно следующей инструкции.  https://serveradmin.ru/nastroyka-opoveshheniy-zabbix-v-telegram/